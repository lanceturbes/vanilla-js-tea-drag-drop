<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Element Factory</title>
    <script type="module" defer>
      function swapItems(itemList, indexA, indexB) {
        const items = itemList.slice();
        const itemB = items[indexB];
        items[indexB] = items[indexA];
        items[indexA] = itemB;
        return items;
      }

      function h(type, attributes, children) {
        return { type, attributes: attributes ?? {}, children };
      }

      function renderNode(element) {
        if (typeof element === "string") {
          return document.createTextNode(element);
        }

        const { type, attributes, children } = element;
        const $el = document.createElement(type);

        for (const attr in attributes) {
          const value = attributes[attr];

          if (attr.startsWith("on") && typeof value === "function") {
            $el.addEventListener(attr.slice(2), value);
          } else {
            $el.setAttribute(attr, value);
          }
        }

        for (const child of children) {
          $el.appendChild(renderNode(child));
        }

        return $el;
      }

      function render(element, node) {
        node.replaceChildren(element);
      }

      // "state" object to keep track of things that should not cause re-renders
      const data = {
        draggedIndex: null,
      };

      function init() {
        return {
          count: 0,
          itemList: [
            { id: 0, name: "Apple" },
            { id: 1, name: "Banana" },
            { id: 2, name: "Cherry" },
          ],
        };
      }

      function update(msg, model) {
        switch (msg.type) {
          case "INCREMENT":
            return { ...model, count: model.count + 1 };

          case "DRAG_END":
            return msg.payload === null || msg.payload === undefined
              ? model
              : {
                  ...model,
                  itemList: swapItems(
                    model.itemList,
                    data.draggedIndex,
                    msg.payload
                  ),
                };

          default:
            return model;
        }
      }

      function view(model, dispatch) {
        return h(
          "div",
          null,
          Array.from({ length: 500 }, () => junkView(model, dispatch))
        );
      }

      /**
       * @see https://github.com/matvp91/lolvdom/blob/master/src/vdom/diff.js
       */
      function diff($node, tree, prevTree) {
        // If next tree is missing, delete node
        if (!tree) {
          $node.remove();
          return;
        }

        // If next tree is string and does not match previous tree, replace
        if (typeof tree === "string" || typeof prevTree === "string") {
          if (tree !== prevTree) {
            $node.replaceWith(renderNode(tree));
          }
          return;
        }

        // If next tree is different tag, replace
        if (tree.type !== prevTree.type) {
          $node.replaceWith(renderNode(tree));
          return;
        }

        // If only children are different, replace them
        prevTree.children.forEach((prevChild, i) => {
          diff($node.childNodes[i], tree.children[i], prevChild);
        });

        // Append any extra elements that were new vs last time
        for (const child of tree.children.slice(prevTree.children.length)) {
          $node.append(renderNode(child));
        }
      }

      function junkView(model, dispatch) {
        return h("div", null, [
          h("button", { onclick: () => dispatch({ type: "INCREMENT" }) }, [
            `Count: ${model.count}`,
          ]),
          h(
            "ul",
            null,
            model.itemList.map((item, i) =>
              h(
                "li",
                {
                  draggable: "true",
                  id: `item-${item.id}`,
                  ondragstart: (event) => {
                    data.draggedIndex = i;
                  },
                  ondrop: (event) => {
                    event.preventDefault();
                    dispatch({ type: "DRAG_END", payload: i });
                  },
                  ondragenter: (event) => {
                    event.preventDefault();
                  },
                  ondragover: (event) => {
                    event.preventDefault();
                    event.dataTransfer.effectAllowed = "move";
                  },
                },
                [item.name]
              )
            )
          ),
        ]);
      }

      /**
       * @see https://github.com/dwyl/learn-elm-architecture-in-javascript
       */
      function main(options, $node) {
        const { init, update, view } = options;
        let model = init();

        function dispatch(msg) {
          const oldView = view(model, dispatch);

          model = update(msg, model);
          const newView = view(model, dispatch);

          diff($node.firstChild, newView, oldView);
        }

        const initialView = view(model, dispatch);
        render(renderNode(initialView), $node);
      }

      const $rootNode = document.getElementById("root");
      main({ init, update, view }, $rootNode);
    </script>
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>
